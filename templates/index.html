{% extends "base.html" %}

{% block content %}
<!-- Dashboard -->
<div id="dashboard" class="aba-conteudo active">
    <div class="page-title">
        <h2>Dashboard</h2>
    </div>

    <div class="cards-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Total de Vendas</h3>
                <div class="card-icon primary">
                    <i class="fas fa-shopping-cart"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="stat-value" id="totalVendas">R$ 0,00</div>
                <div class="stat-label">Receita total do dia</div>
            
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Produtos Vendidos</h3>
                <div class="card-icon success">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="stat-value" id="totalProdutos">0</div>
                <div class="stat-label">Itens vendidos hoje</div>
            </div>
        </div>

    
    </div>

    <div class="cards-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Vendas Recentes</h3>
                <a href="#" class="btn btn-primary" onclick="mostrarAba('vendas')">Ver todas</a>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table id="vendasRecentes">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Vendedor</th>
                                <th>Pagamento</th>
                            </tr>
                        </thead>
                        
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Produtos Mais Vendidos</h3>
                <a href="#" class="btn btn-primary" onclick="mostrarAba('produtos')">Ver todos</a>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Vendas</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vendas -->
<div id="vendas" class="aba-conteudo">
    <div class="page-title">
        <h2>Registrar Venda</h2>
        <button class="btn btn-primary" onclick="exportarPlanilha()">Exportar Planilha</button>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Nova Venda</h3>
        </div>
        <div class="card-body">
            <div id="produtos-venda">
                <!-- Produtos serão adicionados aqui -->
            </div>
            
            <button class="btn btn-primary" onclick="adicionarProduto()" style="margin-bottom: 1.5rem;">
                <i class="fas fa-plus"></i> Adicionar Produto
            </button>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Vendedor</label>
                    <select class="form-control" id="vendedor">
                        <option value="">Selecione o vendedor</option>
                    </select>
                    <small><a href="#" onclick="mostrarAba('funcionarios')">Cadastrar novo funcionário</a></small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Método de Pagamento</label>
                    <select class="form-control" id="metodo-pagamento">
                        <option value="dinheiro">Dinheiro</option>
                        <option value="debito">Débito</option>
                        <option value="credito">Crédito</option>
                        <option value="pix">PIX</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="parcelas-group" style="display: none;">
                <label class="form-label">Número de Parcelas</label>
                <input type="number" class="form-control" id="parcelas" min="1" max="12" value="1">
            </div>
            
            <div class="total-value" id="total-venda">
                Total: R$ 0,00
            </div>
            
            <button class="btn btn-success" onclick="confirmarVenda()" style="width: 100%; padding: 1rem; margin-top: 1rem;">
                <i class="fas fa-check"></i> CONFIRMAR VENDA
            </button>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h3 class="card-title">Histórico de Vendas</h3>
            <div class="filters">
                <select id="filtro-vendas" onchange="filtrarVendas()">
                    <option value="todos">Todas as vendas</option>
                    <option value="hoje">Hoje</option>
                    <option value="semana">Esta semana</option>
                    <option value="mes">Este mês</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table id="tabela-vendas">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Produtos</th>
                            <th>Valor</th>
                            <th>Vendedor</th>
                            <th>Pagamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Lojas (Fiado) -->
<div id="lojas-fiado" class="aba-conteudo">
    <div class="page-title">
        <h2>Registrar Venda Fiada</h2>
        <div style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="exportarPlanilha('lojas')">Exportar Planilha</button>
            <button class="btn btn-success" onclick="mostrarAba('lojas')">
                <i class="fas fa-store"></i> Gerenciar Lojas
            </button>
        </div>
    </div>
    
    <div id="aviso-sem-lojas" style="display: none; margin-bottom: 1.5rem;">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Nenhuma loja cadastrada!</strong> É necessário cadastrar uma loja antes de registrar vendas fiadas.
            <button class="btn btn-sm btn-warning" onclick="mostrarAba('lojas')" style="margin-left: 1rem;">
                Cadastrar Primeira Loja
            </button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Nova Venda Fiada</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Data do Serviço</label>
                <input type="date" class="form-control" id="data-servico" value="">
            </div>
            
            <div class="form-group">
                <label class="form-label">Loja</label>
                <select class="form-control" id="loja-fiado">
                    <option value="">Selecione a loja</option>
                </select>
                <small><a href="#" onclick="mostrarAba('lojas')">Cadastrar nova loja</a></small>
                <div id="info-limite-loja" style="margin-top: 0.5rem; font-size: 0.9rem; display: none;">
                    <span class="badge badge-info">Limite de crédito: <span id="limite-credito-loja">R$ 0,00</span></span>
                </div>
            </div>
            
            <div id="produtos-fiado">
               
            </div>
            
            <button class="btn btn-primary" onclick="adicionarProdutoFiado()" style="margin-bottom: 1.5rem;">
                <i class="fas fa-plus"></i> Adicionar Produto
            </button>
            
            <div class="form-group">
                <label class="form-label">Funcionário</label>
                <input type="text" class="form-control" id="funcionario-fiado" placeholder="Digite o nome do funcionário">
            </div>
            
            <div class="total-value" id="total-fiado">
                Total: R$ 0,00
            </div>
            
            <div id="aviso-limite" style="display: none; margin-top: 1rem;">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Atenção:</strong> Esta venda ultrapassará o limite de crédito da loja!
                </div>
            </div>
            
            <button class="btn btn-success" onclick="confirmarVendaFiada()" style="width: 100%; padding: 1rem; margin-top: 1rem;">
                <i class="fas fa-check"></i> CONFIRMAR VENDA FIADA
            </button>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h3 class="card-title">Contas a Receber</h3>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Loja</th>
                            <th>Última Venda</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>

                </table>
            </div>
        </div>
    </div>
</div>

<!-- Funcionários -->
<div id="funcionarios" class="aba-conteudo">
    <div class="page-title">
        <h2>Gerenciar Funcionários</h2>
        <button class="btn btn-primary" onclick="limparFormularioFuncionario()">Novo Funcionário</button>
    </div>
    
    <div class="cards-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Cadastro de Funcionário</h3>
                <div class="card-icon primary">
                    <i class="fas fa-user-plus"></i>
                </div>
            </div>
            <div class="card-body">
                <form id="formFuncionario">
                    <input type="hidden" id="funcionarioId" />

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="nomeFuncionario">Nome:</label>
                            <input
                                type="text"
                                id="nomeFuncionario"
                                name="nome"
                                class="form-control"
                                required
                                placeholder="Digite o nome completo"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="dataEntrada">Data de Entrada:</label>
                            <input
                                type="date"
                                id="dataEntrada"
                                name="data_entrada"
                                class="form-control"
                                required
                            />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="cargo">Cargo:</label>
                            <select id="cargo" name="cargo" class="form-control">
                                <option value="Vendedor">Vendedor</option>
                                <option value="Gerente">Gerente</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Entregador">Entregador</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="salario">Salário (R$):</label>
                            <input
                                type="number"
                                id="salario"
                                name="salario"
                                class="form-control"
                                step="0.01"
                                min="0"
                                placeholder="0,00"
                            />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="telefoneFuncionario">Telefone:</label>
                            <input
                                type="tel"
                                id="telefoneFuncionario"
                                name="telefone"
                                class="form-control"
                                placeholder="(00) 00000-0000"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">E-mail:</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                class="form-control"
                                placeholder="email@exemplo.com"
                            />
                        </div>
                    </div>


                    <div class="flex gap-2" style="display: flex; gap: 0.5rem; margin-top: 1.5rem">
                        <button type="button" onclick="salvarFuncionario()" id="btnSalvarFuncionario" class="btn btn-primary">
                            <i class="fas fa-save"></i> Cadastrar Funcionário
                        </button>
                        <button type="button" onclick="limparFormularioFuncionario()" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Resumo da Equipe</h3>
                <div class="card-icon success">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="stat-value" id="totalFuncionarios">0</div>
                <div class="stat-label">Funcionários ativos</div>

                <div style="margin-top: 1.5rem">
                    <div class="stat-value" style="font-size: 1.5rem" id="totalVendedores">0</div>
                    <div class="stat-label">Vendedores</div>
                </div>

                <div style="margin-top: 1rem">
                    <div class="stat-value" style="font-size: 1.5rem" id="totalAdministrativos">0</div>
                    <div class="stat-label">Administrativos</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Lista de Funcionários</h3>
            <div class="filters">
                <select id="filtroCargo" style="margin-right: 1rem">
                    <option value="">Todos os cargos</option>
                    <option value="Vendedor">Vendedor</option>
                    <option value="Gerente">Gerente</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Entregador">Entregador</option>
                </select>
                <input
                    type="text"
                    id="buscarFuncionario"
                    placeholder="Buscar funcionário..."
                    class="form-control"
                    style="width: 250px"
                />
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cargo</th>
                            <th>Data de Entrada</th>
                            <th>Salário</th>
                            <th>Telefone</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Lojas -->
<div id="lojas" class="aba-conteudo">
    <div class="page-title">
        <h2>Gerenciamento de Lojas</h2>
        <button class="btn btn-primary" onclick="limparFormularioLoja()">Nova Loja</button>
    </div>

    <div class="cards-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Cadastro de Loja</h3>
                <div class="card-icon primary">
                    <i class="fas fa-store"></i>
                </div>
            </div>
            <div class="card-body">
                <form id="formLoja">
                    <input type="hidden" id="lojaId" />

                    <div class="form-group">
                        <label class="form-label" for="nomeLoja">Nome da Loja:</label>
                        <input
                            type="text"
                            id="nomeLoja"
                            name="nome"
                            class="form-control"
                            required
                            placeholder="Digite o nome da loja"
                        />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="telefoneLoja">Telefone:</label>
                            <input
                                type="tel"
                                id="telefoneLoja"
                                name="telefone"
                                class="form-control"
                                placeholder="(00) 00000-0000"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="responsavel">Responsável:</label>
                            <input
                                type="text"
                                id="responsavel"
                                name="responsavel"
                                class="form-control"
                                placeholder="Nome do responsável"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="enderecoLoja">Endereço:</label>
                        <textarea
                            id="enderecoLoja"
                            name="endereco"
                            class="form-control"
                            rows="3"
                            placeholder="Digite o endereço completo"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="limiteCredito">Limite de Crédito (R$):</label>
                        <input
                            type="number"
                            id="limiteCredito"
                            name="limite_credito"
                            class="form-control"
                            step="0.01"
                            min="0"
                            placeholder="0,00"
                        />
                    </div>


                    <div class="flex gap-2" style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                        <button type="button" onclick="salvarLoja()" id="btnSalvarLoja" class="btn btn-primary">
                            <i class="fas fa-save"></i> Cadastrar Loja
                        </button>
                        <button type="button" onclick="limparFormularioLoja()" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Resumo das Lojas</h3>
                <div class="card-icon warning">
                    <i class="fas fa-chart-pie"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="stat-value" id="totalLojas">0</div>
                <div class="stat-label">Lojas cadastradas</div>
                
                <div style="margin-top: 1.5rem;">
                    <div class="stat-value" style="font-size: 1.5rem;" id="lojasAtivas">0</div>
                    <div class="stat-label">Lojas ativas</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Lista de Lojas</h3>
            <div class="filters">
                <input
                    type="text"
                    id="buscarLoja"
                    placeholder="Buscar loja..."
                    class="form-control"
                    style="width: 250px;"
                />
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Responsável</th>
                            <th>Limite Crédito</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaLojas">
                        <tr>
                            <td colspan="6" class="text-center">Nenhuma loja cadastrada</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Produtos -->
<div id="produtos" class="aba-conteudo">
    <div class="page-title">
        <h2>Gerenciar Produtos</h2>
        <button class="btn btn-primary" onclick="limparFormularioProduto()">Novo Produto</button>
    </div>
    
    <div class="cards-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Cadastro de Produto</h3>
                <div class="card-icon primary">
                    <i class="fas fa-box"></i>
                </div>
            </div>
            <div class="card-body">
                <form id="formProduto">
                    <input type="hidden" id="produtoId" />

                    <div class="form-group">
                        <label class="form-label" for="nomeProduto">Nome do Produto:</label>
                        <input
                            type="text"
                            id="nomeProduto"
                            name="nome"
                            class="form-control"
                            required
                            placeholder="Digite o nome do produto"
                        />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="subcategoria">Subcategoria (opcional):</label>
                            <input
                                type="text"
                                id="subcategoria"
                                name="subcategoria"
                                class="form-control"
                                placeholder="Ex: Colorido, A4, etc."
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="valor">Valor (R$):</label>
                            <input
                                type="number"
                                id="valor"
                                name="valor"
                                step="0.01"
                                min="0"
                                class="form-control"
                                required
                                placeholder="0,00"
                            />
                        </div>
                    </div>

                    

                    <div class="flex gap-2" style="display: flex; gap: 0.5rem; margin-top: 1.5rem">
                        <button type="button" onclick="salvarProduto()" id="btnSalvarProduto" class="btn btn-primary">
                            <i class="fas fa-save"></i> Cadastrar Produto
                        </button>
                        <button type="button" onclick="limparFormularioProduto()" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Resumo de Produtos</h3>
                <div class="card-icon success">
                    <i class="fas fa-chart-bar"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="stat-value" id="totalProdutosCadastrados">0</div>
                <div class="stat-label">Produtos cadastrados</div>

                <div style="margin-top: 1.5rem">
                    <div class="stat-value" style="font-size: 1.5rem" id="totalProdutosAtivos">0</div>
                    <div class="stat-label">Produtos ativos</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Lista de Produtos</h3>
            <div class="filters" style="display: flex; gap: 1rem">
                <input
                    type="text"
                    id="buscarProduto"
                    placeholder="Buscar produto..."
                    class="form-control"
                    style="width: 250px"
                />
                <select
                    id="filtroCategoria"
                    class="form-control"
                    style="width: 200px"
                >
                    <option value="">Todas as categorias</option>
                    <option value="Papel">Papel</option>
                    <option value="Impressão">Impressão</option>
                    <option value="Encadernação">Encadernação</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Subcategoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaProdutos">
                        <tr>
                            <td colspan="5" class="text-center">Nenhum produto cadastrado</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/vendas.js"></script>
<script src="/static/js/servicos.js"></script>

<script>
// Função para formatar valor em moeda
function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}

// Função para carregar lojas no select de fiado
async function carregarLojasFiado() {
    try {
        const response = await fetch('/api/lojas');
        const lojas = await response.json();
        
        const select = document.getElementById('loja-fiado');
        const aviso = document.getElementById('aviso-sem-lojas');
        
        select.innerHTML = '<option value="">Selecione a loja</option>';
        
        if (lojas.length === 0) {
            // Mostra aviso
            aviso.style.display = 'block';
            
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "Nenhuma loja cadastrada";
            option.disabled = true;
            select.appendChild(option);
            
            // Desabilita o formulário
            document.querySelectorAll('#lojas-fiado .form-control, #lojas-fiado button').forEach(el => {
                if (el.id !== 'aviso-sem-lojas' && !el.closest('.alert')) {
                    el.disabled = true;
                }
            });
        } else {
            // Esconde aviso e habilita formulário
            aviso.style.display = 'none';
            document.querySelectorAll('#lojas-fiado .form-control, #lojas-fiado button').forEach(el => {
                el.disabled = false;
            });
            
            // Preenche as opções
            lojas.forEach(loja => {
                const option = document.createElement('option');
                option.value = loja.id;
                option.textContent = `${loja.nome} (${loja.responsavel || 'Sem responsável'})`;
                option.setAttribute('data-limite', loja.limite_credito || 0);
                select.appendChild(option);
            });
        }
        
        // Carrega o dashboard
        await carregarDashboard();
        
    } catch (error) {
        console.error('Erro ao carregar lojas:', error);
    }
}

// Função para carregar lista de lojas na aba de Lojas
async function carregarListaLojas() {
    try {
        const response = await fetch('/api/lojas');
        const lojas = await response.json();
        
        const tbody = document.getElementById('tabelaLojas');
        
        if (lojas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div style="padding: 2rem; text-align: center;">
                            <i class="fas fa-store fa-2x" style="color: #ccc; margin-bottom: 1rem;"></i>
                            <p style="color: #666; margin-bottom: 1rem;">Nenhuma loja cadastrada</p>
                            <button class="btn btn-primary" onclick="limparFormularioLoja()">
                                <i class="fas fa-plus"></i> Cadastrar Primeira Loja
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            // Atualiza resumo
            document.getElementById('totalLojas').textContent = '0';
            document.getElementById('lojasAtivas').textContent = '0';
            
        } else {
            tbody.innerHTML = '';
            
            let totalLojas = 0;
            let lojasAtivas = 0;
            
            lojas.forEach(loja => {
                totalLojas++;
                if (loja.ativo !== false) lojasAtivas++;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${loja.nome}</strong></td>
                    <td>${loja.telefone || '-'}</td>
                    <td>${loja.responsavel || '-'}</td>
                    <td>${formatarMoeda(loja.limite_credito || 0)}</td>
                    <td>
                        <span class="badge ${loja.ativo !== false ? 'badge-success' : 'badge-secondary'}">
                            ${loja.ativo !== false ? 'Ativa' : 'Inativa'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarLoja(${loja.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="excluirLoja(${loja.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Atualiza resumo
            document.getElementById('totalLojas').textContent = totalLojas;
            document.getElementById('lojasAtivas').textContent = lojasAtivas;
        }
        
    } catch (error) {
        console.error('Erro ao carregar lojas:', error);
        const tbody = document.getElementById('tabelaLojas');
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div style="padding: 2rem; text-align: center;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="color: #e74c3c; margin-bottom: 1rem;"></i>
                        <p style="color: #666;">Erro ao carregar lojas</p>
                        <button class="btn btn-primary" onclick="carregarListaLojas()">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
}

// Função para mostrar informações da loja selecionada
function mostrarInfoLoja() {
    const select = document.getElementById('loja-fiado');
    const selectedOption = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('info-limite-loja');
    const avisoLimite = document.getElementById('aviso-limite');
    
    if (select.value && selectedOption) {
        const limiteCredito = parseFloat(selectedOption.getAttribute('data-limite') || 0);
        
        document.getElementById('limite-credito-loja').textContent = formatarMoeda(limiteCredito);
        
        infoDiv.style.display = 'block';
        avisoLimite.style.display = 'none';
    } else {
        infoDiv.style.display = 'none';
        avisoLimite.style.display = 'none';
    }
}

// Função para verificar limite ao adicionar produtos
function verificarLimite() {
    const select = document.getElementById('loja-fiado');
    const selectedOption = select.options[select.selectedIndex];
    const avisoLimite = document.getElementById('aviso-limite');
    
    if (!select.value) return;
    
    const limiteCredito = parseFloat(selectedOption.getAttribute('data-limite') || 0);
    
    // Calcula total da venda atual
    let totalVenda = 0;
    document.querySelectorAll('#produtos-fiado .produto-item').forEach(item => {
        const selectProduto = item.querySelector('.produto-select');
        const quantidade = item.querySelector('.quantidade');
        const valorInput = item.querySelector('.valor');
        
        let valor = 0;
        if (selectProduto.value) {
            const selectedProdutoOption = selectProduto.options[selectProduto.selectedIndex];
            valor = parseFloat(selectedProdutoOption.getAttribute('data-valor') || 0);
        } else if (valorInput.value) {
            valor = parseFloat(valorInput.value);
        }
        
        const qtd = parseFloat(quantidade.value) || 0;
        totalVenda += valor * qtd;
    });
    
    // Verifica se a venda ultrapassa o limite
    if (limiteCredito > 0 && totalVenda > limiteCredito) {
        avisoLimite.style.display = 'block';
    } else {
        avisoLimite.style.display = 'none';
    }
}

// Função para carregar contas a receber
async function carregarContasReceber() {
    try {
        const response = await fetch('/api/lojas');
        const lojas = await response.json();
        
        const tbody = document.getElementById('contasReceber');
        tbody.innerHTML = '';
        
        if (lojas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">
                        <div style="padding: 2rem; text-align: center;">
                            <i class="fas fa-check-circle fa-2x" style="color: #2ecc71; margin-bottom: 1rem;"></i>
                            <p style="color: #666;">Nenhuma loja com vendas fiadas</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        lojas.forEach(loja => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${loja.nome}</strong></td>
                <td>${loja.ultima_venda_fiada ? new Date(loja.ultima_venda_fiada).toLocaleDateString('pt-BR') : 'Nenhuma'}</td>
                <td>
                    <span class="badge badge-success">Ativa</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="verDetalhesLoja(${loja.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Erro ao carregar contas a receber:', error);
        document.getElementById('contasReceber').innerHTML = `
            <tr>
                <td colspan="4" class="text-center">
                    <div style="padding: 2rem; text-align: center;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="color: #e74c3c; margin-bottom: 1rem;"></i>
                        <p style="color: #666;">Erro ao carregar dados</p>
                        <button class="btn btn-primary" onclick="carregarContasReceber()">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
}

// Função para carregar dashboard
async function carregarDashboard() {
    try {
        // Busca vendas do dia para calcular totais
        const hoje = new Date().toISOString().split('T')[0];
        const vendasResponse = await fetch(`/api/vendas?data=${hoje}`);
        const vendasHoje = await vendasResponse.json();
        
        let totalVendasHoje = 0;
        let totalProdutosHoje = 0;
        let totalVendasFiadasHoje = 0;
        
        vendasHoje.forEach(venda => {
            totalVendasHoje += parseFloat(venda.total || 0);
            totalProdutosHoje += venda.produtos ? venda.produtos.reduce((acc, prod) => acc + (prod.quantidade || 0), 0) : 0;
            if (venda.fiado) totalVendasFiadasHoje++;
        });
        
        // Atualiza dashboard
        document.getElementById('totalVendas').textContent = formatarMoeda(totalVendasHoje);
        document.getElementById('totalProdutos').textContent = totalProdutosHoje;
        document.getElementById('totalVendasFiadas').textContent = totalVendasFiadasHoje;
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
    }
}

// Funções para lojas
function limparFormularioLoja() {
    document.getElementById('formLoja').reset();
    document.getElementById('lojaId').value = '';
    document.getElementById('ativoLoja').checked = true;
    document.getElementById('btnSalvarLoja').innerHTML = '<i class="fas fa-save"></i> Cadastrar Loja';
    document.getElementById('nomeLoja').focus();
}

async function salvarLoja() {
    const form = document.getElementById('formLoja');
    const lojaId = document.getElementById('lojaId').value;
    
    const lojaData = {
        nome: document.getElementById('nomeLoja').value,
        telefone: document.getElementById('telefoneLoja').value,
        responsavel: document.getElementById('responsavel').value,
        endereco: document.getElementById('enderecoLoja').value,
        limite_credito: parseFloat(document.getElementById('limiteCredito').value) || 0,
        ativo: document.getElementById('ativoLoja').checked
    };
    
    if (!lojaData.nome) {
        alert('Informe o nome da loja!');
        return;
    }
    
    try {
        const url = lojaId ? `/api/lojas/${lojaId}` : '/api/lojas';
        const method = lojaId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(lojaData)
        });
        
        if (response.ok) {
            alert(lojaId ? 'Loja atualizada com sucesso!' : 'Loja cadastrada com sucesso!');
            
            // Limpar formulário
            limparFormularioLoja();
            
            // Recarregar listas
            carregarListaLojas();
            carregarLojasFiado();
            carregarDashboard();
            carregarContasReceber();
            
        } else {
            const error = await response.json();
            alert(`Erro: ${error.message || 'Falha ao salvar loja'}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar loja');
    }
}

async function editarLoja(id) {
    try {
        const response = await fetch(`/api/lojas/${id}`);
        const loja = await response.json();
        
        document.getElementById('lojaId').value = loja.id;
        document.getElementById('nomeLoja').value = loja.nome;
        document.getElementById('telefoneLoja').value = loja.telefone || '';
        document.getElementById('responsavel').value = loja.responsavel || '';
        document.getElementById('enderecoLoja').value = loja.endereco || '';
        document.getElementById('limiteCredito').value = loja.limite_credito || '';
        document.getElementById('ativoLoja').checked = loja.ativo !== false;
        
        document.getElementById('btnSalvarLoja').innerHTML = '<i class="fas fa-save"></i> Atualizar Loja';
        
        // Rola para o formulário
        document.getElementById('formLoja').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Erro ao buscar loja:', error);
        alert('Erro ao carregar dados da loja');
    }
}

function excluirLoja(id) {
    if (confirm('Tem certeza que deseja excluir esta loja?')) {
        fetch(`/api/lojas/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('Loja excluída com sucesso!');
                carregarListaLojas();
                carregarLojasFiado();
                carregarDashboard();
                carregarContasReceber();
            } else {
                alert('Erro ao excluir loja');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir loja');
        });
    }
}

// Funções auxiliares
function verDetalhesLoja(lojaId) {
    // Implemente a função para ver detalhes da loja
    alert(`Detalhes da loja ${lojaId} - Implemente esta função`);
}

// Quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarDashboard();
    carregarListaLojas();
    carregarContasReceber();
    
    const linksMenu = document.querySelectorAll('.nav-link');
    linksMenu.forEach(link => {
        link.addEventListener('click', function() {
            if (this.getAttribute('onclick')?.includes("mostrarAba('lojas-fiado')")) {
                setTimeout(() => {
                    carregarLojasFiado();
                }, 100);
            } else if (this.getAttribute('onclick')?.includes("mostrarAba('dashboard')")) {
                setTimeout(() => {
                    carregarDashboard();
                }, 100);
            } else if (this.getAttribute('onclick')?.includes("mostrarAba('lojas')")) {
                setTimeout(() => {
                    carregarListaLojas();
                }, 100);
            }
        });
    });
    
    if (document.getElementById('lojas-fiado').classList.contains('active')) {
        carregarLojasFiado();
    }
});

// Função para mostrar abas
function mostrarAba(aba) {
    document.querySelectorAll('.aba-conteudo').forEach(el => {
        el.classList.remove('active');
    });
    document.getElementById(aba).classList.add('active');
    
    if (aba === 'lojas-fiado') {
        setTimeout(() => {
            carregarLojasFiado();
        }, 100);
    } else if (aba === 'dashboard') {
        setTimeout(() => {
            carregarDashboard();
        }, 100);
    } else if (aba === 'lojas') {
        setTimeout(() => {
            carregarListaLojas();
        }, 100);
    }
}

// Função para adicionar produto fiado
function adicionarProdutoFiado() {
    const container = document.getElementById('produtos-fiado');
    
    const produtoDiv = document.createElement('div');
    produtoDiv.className = 'produto-item';
    produtoDiv.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Produto</label>
                <select class="form-control produto-select" onchange="atualizarTotalFiado(); verificarLimite();">
                    <option value="">Selecione o produto</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Quantidade</label>
                <input type="number" class="form-control quantidade" value="1" min="1" onchange="atualizarTotalFiado(); verificarLimite();">
            </div>
            <div class="form-group">
                <label class="form-label">Valor Unitário</label>
                <input type="number" class="form-control valor" step="0.01" min="0" onchange="atualizarTotalFiado(); verificarLimite();">
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button type="button" class="btn btn-danger" onclick="this.closest('.produto-item').remove(); atualizarTotalFiado(); verificarLimite();">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(produtoDiv);
    carregarProdutosSelect(produtoDiv.querySelector('.produto-select'));
}

// Função para carregar produtos no select
async function carregarProdutosSelect(selectElement) {
    try {
        const response = await fetch('/api/produtos');
        const produtos = await response.json();
        
        selectElement.innerHTML = '<option value="">Selecione o produto</option>';
        
        produtos.forEach(produto => {
            const option = document.createElement('option');
            option.value = produto.id;
            option.textContent = `${produto.nome} - ${formatarMoeda(produto.valor)}`;
            option.setAttribute('data-valor', produto.valor);
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

// Função para atualizar total fiado
function atualizarTotalFiado() {
    let total = 0;
    
    document.querySelectorAll('#produtos-fiado .produto-item').forEach(item => {
        const select = item.querySelector('.produto-select');
        const quantidade = item.querySelector('.quantidade');
        const valorInput = item.querySelector('.valor');
        
        let valor = 0;
        
        if (select.value) {
            const selectedOption = select.options[select.selectedIndex];
            valor = parseFloat(selectedOption.getAttribute('data-valor') || 0);
            valorInput.value = valor;
        } else if (valorInput.value) {
            valor = parseFloat(valorInput.value);
        }
        
        const qtd = parseFloat(quantidade.value) || 0;
        total += valor * qtd;
    });
    
    document.getElementById('total-fiado').textContent = `Total: ${formatarMoeda(total)}`;
    verificarLimite();
}

// Função para confirmar venda fiada
async function confirmarVendaFiada() {
    const lojaId = document.getElementById('loja-fiado').value;
    const dataServico = document.getElementById('data-servico').value;
    const funcionario = document.getElementById('funcionario-fiado').value;
    const select = document.getElementById('loja-fiado');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!lojaId) {
        alert('Selecione uma loja!');
        return;
    }
    
    if (!dataServico) {
        alert('Informe a data do serviço!');
        return;
    }
    
    if (!funcionario) {
        alert('Informe o nome do funcionário!');
        return;
    }
    
    const limiteCredito = parseFloat(selectedOption.getAttribute('data-limite') || 0);
    
    const produtos = [];
    let totalVenda = 0;
    
    document.querySelectorAll('#produtos-fiado .produto-item').forEach(item => {
        const select = item.querySelector('.produto-select');
        const quantidade = item.querySelector('.quantidade');
        const valorInput = item.querySelector('.valor');
        
        if (select.value) {
            const produto = {
                produto_id: select.value,
                quantidade: parseFloat(quantidade.value) || 0,
                valor_unitario: parseFloat(valorInput.value) || 0
            };
            
            produtos.push(produto);
            totalVenda += produto.quantidade * produto.valor_unitario;
        }
    });
    
    if (produtos.length === 0) {
        alert('Adicione pelo menos um produto!');
        return;
    }
    
    if (limiteCredito > 0 && totalVenda > limiteCredito) {
        const confirmacao = confirm(
            `ATENÇÃO: Esta venda de ${formatarMoeda(totalVenda)} ultrapassará o limite de crédito da loja!\n` +
            `Limite: ${formatarMoeda(limiteCredito)}\n\n` +
            `Deseja continuar mesmo assim?`
        );
        
        if (!confirmacao) {
            return;
        }
    }
    
    const vendaData = {
        loja_id: lojaId,
        data_servico: dataServico,
        funcionario: funcionario,
        produtos: produtos,
        total: totalVenda
    };
    
    try {
        const response = await fetch('/api/vendas/fiado', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(vendaData)
        });
        
        if (response.ok) {
            alert('Venda fiada registrada com sucesso!');
            
            document.getElementById('produtos-fiado').innerHTML = '';
            document.getElementById('data-servico').value = '';
            document.getElementById('loja-fiado').value = '';
            document.getElementById('funcionario-fiado').value = '';
            document.getElementById('info-limite-loja').style.display = 'none';
            document.getElementById('aviso-limite').style.display = 'none';
            document.getElementById('total-fiado').textContent = 'Total: R$ 0,00';
            
            carregarLojasFiado();
            carregarDashboard();
            carregarListaLojas();
            carregarContasReceber();
            
        } else {
            const error = await response.json();
            alert(`Erro: ${error.message || 'Falha ao registrar venda'}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao registrar venda fiada');
    }
}
</script>
{% endblock %}